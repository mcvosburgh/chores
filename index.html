<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Chores Chart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; 
        }
        .chore-item {
            display: flex;
            align-items: center;
            padding: 2px 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.7rem; 
        }
        .chore-item:last-child { border-bottom: none; }
        .chore-item input[type="checkbox"] {
            margin-right: 6px; width: 0.8rem; height: 0.8rem;
            accent-color: #6b7280; flex-shrink: 0; 
        }
        .chore-item label[contenteditable="true"] {
            min-width: 50px; flex-grow: 1; color: #374151; cursor: text;
            padding: 2px 4px; /* Add some padding for easier editing */
        }
        .day-header-container .day-name { font-size: 0.875rem; color: #4b5563; padding: 0.5rem 0;}
        .member-name-cell { position: sticky; left: 0; z-index: 10; background-color: inherit; }
        .member-name-cell-content { min-width: 80px; font-weight: 500; }
        .table-container { overflow-x: auto; }
        [contenteditable="true"]:focus {
            outline: 2px solid #4f46e5; /* Tailwind indigo-600 for focus */
            background-color: #eef2ff; /* Tailwind indigo-50 for focus background */
            border-radius: 2px;
        }
        .chart-title { color: #1f2937; }
        .member-header-cell, .day-header-cell { background-color: #f3f4f6; color: #374151; }
        .member-row-color { background-color: #fdfdfe; }
        .member-row-text-color { color: #374151; }
        #loadingIndicator {
            text-align: center; padding: 20px; font-size: 1.2rem; color: #4b5563;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden">
        <div class="p-4 sm:p-6 border-b border-gray-200 flex flex-col sm:flex-row justify-center items-center">
            <h2 class="text-xl sm:text-2xl font-semibold chart-title mb-2 sm:mb-0">The Vosburgh Chore Chart</h2>
        </div>

        <div id="loadingIndicator">Loading chores...</div>
        <div class="table-container hidden" id="choreChartContainer">
            <div class="grid grid-cols-[minmax(100px,_0.7fr)_repeat(7,_1fr)]" id="choreGrid">
                {/* Grid will be populated by JavaScript */}
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"; // For debugging

        // --- Configuration and Constants ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const initialDaysOfWeek = ["SUNDAY", "MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY"];
        const choresPerDay = 11; // 5 existing + 6 blank rows

        const defaultMemberConfig = [ // Renamed from defaultMemberChores for clarity
            { name: "MOM", defaultChoresList: ["Water plants", "Meal prep", "Pay bills", "Laundry", "Errands"] },
            { name: "DAD", defaultChoresList: ["Take out trash", "Mow lawn", "Dish Duty", "Walk the dog", "Recycling"] },
            { name: "JP", defaultChoresList: ["Clean room", "Homework", "Set table", "Feed pet", "Tidy common area"] },
            { name: "HELEN", defaultChoresList: ["Tidy toys", "Help with dishes", "Practice instrument", "Read book", "Put away shoes"] },
            { name: "HENRY", defaultChoresList: ["Clear plate", "Toy pickup", "Water a small plant", "Help sort socks", "Chore J"] },
            { name: "LEO", defaultChoresList: ["Make bed", "Put away clothes", "Help with groceries", "Wipe table", "Chore E"] }
        ];

        // --- Firebase Initialization ---
        let app, auth, db, userId;
        let choreDataUnsubscribe = null; // To detach listener on re-auth

        const loadingIndicator = document.getElementById('loadingIndicator');
        const choreChartContainer = document.getElementById('choreChartContainer');
        const choreGrid = document.getElementById('choreGrid');

        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is not available.");
                loadingIndicator.textContent = "Error: Firebase configuration missing.";
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); 

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        userId = user.uid;
                        if (choreDataUnsubscribe) choreDataUnsubscribe(); 
                        await loadAndRenderChores();
                    } else {
                        console.log("User is signed out. Attempting to sign in...");
                        userId = null; 
                        if (choreDataUnsubscribe) choreDataUnsubscribe();
                        choreChartContainer.classList.add('hidden');
                        loadingIndicator.textContent = "Authenticating...";
                        loadingIndicator.classList.remove('hidden');
                        attemptSignIn(); 
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                loadingIndicator.textContent = "Error initializing. Please try again.";
            }
        }
        
        async function attemptSignIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Error during sign-in:", error);
                loadingIndicator.textContent = "Authentication failed. Please refresh.";
            }
        }

        // --- Data Handling Functions ---
        // Generates the initial data structure with choresByDay as a JSON string
        function getInitialChoreDataForStorage() {
            return defaultMemberConfig.map(memberConf => ({
                name: memberConf.name,
                choresByDayString: JSON.stringify( // Stringify the nested array
                    Array(7).fill(null).map(() => 
                        Array(choresPerDay).fill(null).map((_, choreIndex) => ({
                            text: memberConf.defaultChoresList[choreIndex] || "", 
                            checked: false
                        }))
                    )
                )
            }));
        }
        
        // Helper to parse data for rendering
        function parseMembersDataForRendering(membersFromDb) {
            if (!Array.isArray(membersFromDb)) {
                console.warn("membersFromDb is not an array, returning empty array for rendering.", membersFromDb);
                return [];
            }
            return membersFromDb.map(member => {
                let choresByDayArray = [];
                try {
                    if (member.choresByDayString && typeof member.choresByDayString === 'string') {
                        choresByDayArray = JSON.parse(member.choresByDayString);
                    } else {
                         console.warn(`choresByDayString for member ${member.name} is missing or not a string. Initializing empty.`);
                         // Fallback to an empty structure if string is missing/invalid
                         choresByDayArray = Array(7).fill(null).map(() => Array(choresPerDay).fill(null).map(() => ({ text: "", checked: false })));
                    }
                } catch (e) {
                    console.error(`Error parsing choresByDayString for member ${member.name}:`, e);
                    // Fallback to an empty structure on parse error
                    choresByDayArray = Array(7).fill(null).map(() => Array(choresPerDay).fill(null).map(() => ({ text: "", checked: false })));
                }
                return {
                    name: member.name,
                    choresByDay: choresByDayArray // This is now the nested array
                };
            });
        }


        async function loadAndRenderChores() {
            if (!userId) {
                console.log("User not authenticated, cannot load chores.");
                return;
            }
            loadingIndicator.textContent = "Loading chores...";
            loadingIndicator.classList.remove('hidden');
            choreChartContainer.classList.add('hidden');

            const choreDocRef = doc(db, "artifacts", appId, "users", userId, "choreChartData", "main");
            
            choreDataUnsubscribe = onSnapshot(choreDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const dataFromDb = docSnap.data();
                    console.log("Loaded data from Firestore:", dataFromDb);
                    const membersToRender = parseMembersDataForRendering(dataFromDb.members);
                    renderChoreChart(membersToRender);
                } else {
                    console.log("No chore data found, initializing with defaults.");
                    const initialDataForStorage = { members: getInitialChoreDataForStorage() };
                    setDoc(choreDocRef, initialDataForStorage)
                        .then(() => {
                            console.log("Initial data set in Firestore.");
                            // Parse the just-stored data for rendering
                            const membersToRender = parseMembersDataForRendering(initialDataForStorage.members);
                            renderChoreChart(membersToRender);
                        })
                        .catch(error => console.error("Error setting initial document:", error));
                }
                loadingIndicator.classList.add('hidden');
                choreChartContainer.classList.remove('hidden');
            }, (error) => {
                console.error("Error getting chore data snapshot:", error);
                loadingIndicator.textContent = "Error loading chores. Please refresh.";
            });
        }
        
        async function updateChoreProperty(memberIndex, dayIndex, choreIndex, propertyName, newValue) {
            if (!userId) {
                console.error("Cannot update chore: User not authenticated.");
                return;
            }
            const choreDocRef = doc(db, "artifacts", appId, "users", userId, "choreChartData", "main");
            try {
                const docSnap = await getDoc(choreDocRef);
                if (docSnap.exists()) {
                    const membersDataFromDb = docSnap.data().members;
                    if (!Array.isArray(membersDataFromDb) || !membersDataFromDb[memberIndex]) {
                        console.error("Invalid members data structure in Firestore or memberIndex out of bounds.");
                        return;
                    }

                    const targetMemberFromDb = membersDataFromDb[memberIndex];
                    let choresByDayArray;
                    try {
                        choresByDayArray = JSON.parse(targetMemberFromDb.choresByDayString);
                    } catch (e) {
                        console.error("Error parsing choresByDayString during update:", e);
                        // Initialize with empty structure if parsing fails, to prevent further errors
                        choresByDayArray = Array(7).fill(null).map(() => Array(choresPerDay).fill(null).map(() => ({ text: "", checked: false })));
                    }

                    // Ensure the nested structure is valid before attempting to update
                    if (choresByDayArray && choresByDayArray[dayIndex] && choresByDayArray[dayIndex][choreIndex]) {
                        choresByDayArray[dayIndex][choreIndex][propertyName] = newValue;
                        
                        // Create a deep copy of membersDataFromDb to modify
                        const updatedMembersData = JSON.parse(JSON.stringify(membersDataFromDb));
                        updatedMembersData[memberIndex].choresByDayString = JSON.stringify(choresByDayArray);
                        
                        await updateDoc(choreDocRef, { members: updatedMembersData });
                        console.log(`Chore ${propertyName} for member ${memberIndex}, day ${dayIndex}, chore ${choreIndex} updated to ${newValue}.`);
                    } else {
                        console.error("Chore path invalid for update. Structure:", memberIndex, dayIndex, choreIndex, choresByDayArray);
                    }
                } else {
                    console.error("Document does not exist, cannot update chore.");
                }
            } catch (error) {
                console.error(`Error updating chore ${propertyName}:`, error);
            }
        }


        async function updateChoreText(memberIndex, dayIndex, choreIndex, newText) {
            await updateChoreProperty(memberIndex, dayIndex, choreIndex, "text", newText);
        }

        async function updateChoreChecked(memberIndex, dayIndex, choreIndex, isChecked) {
            await updateChoreProperty(memberIndex, dayIndex, choreIndex, "checked", isChecked);
        }


        // --- UI Rendering Functions ---
        function renderChoreChart(membersDataToRender) { // Parameter now expects parsed data
            choreGrid.innerHTML = ''; 

            const memberHeaderCell = document.createElement('div');
            memberHeaderCell.className = "p-2 sm:p-3 border-b border-r border-gray-300 font-semibold text-xs sm:text-sm text-center member-name-cell member-header-cell flex items-center justify-center";
            choreGrid.appendChild(memberHeaderCell);

            initialDaysOfWeek.forEach(dayName => {
                const dayCell = document.createElement('div');
                dayCell.className = "p-1 sm:p-2 border-b border-r border-gray-300 text-center day-header-container day-header-cell";
                const dayNameDiv = document.createElement('div');
                dayNameDiv.className = "day-name font-medium";
                dayNameDiv.textContent = dayName;
                dayCell.appendChild(dayNameDiv);
                choreGrid.appendChild(dayCell);
            });

            if (!Array.isArray(membersDataToRender)) {
                console.error("membersDataToRender is not an array in renderChoreChart:", membersDataToRender);
                return; // Prevent further errors
            }

            membersDataToRender.forEach((member, memberIndex) => {
                const memberNameCell = document.createElement('div');
                memberNameCell.className = `member-name-cell p-2 sm:p-3 border-b border-r border-gray-300 member-row-color member-row-text-color text-xs sm:text-sm flex items-center justify-center text-center`;
                const memberNameSpan = document.createElement('span');
                memberNameSpan.className = "member-name-cell-content";
                memberNameSpan.textContent = member.name;
                memberNameCell.appendChild(memberNameSpan);
                choreGrid.appendChild(memberNameCell);

                // member.choresByDay should now be a proper nested array
                if (!Array.isArray(member.choresByDay)) {
                    console.error(`member.choresByDay for ${member.name} is not an array.`, member.choresByDay);
                    // Fill with empty cells to prevent breaking layout
                    for(let i=0; i < 7; i++) {
                         const emptyDayCell = document.createElement('div');
                         emptyDayCell.className = `p-1 sm:p-2 border-b border-r border-gray-300 member-row-color`;
                         choreGrid.appendChild(emptyDayCell);
                    }
                    return; // Skip rendering chores for this member if data is malformed
                }

                member.choresByDay.forEach((dayChores, dayIndex) => {
                    const dayChoresCell = document.createElement('div');
                    dayChoresCell.className = `p-1 sm:p-2 border-b border-r border-gray-300 member-row-color`;
                    
                    if (!Array.isArray(dayChores)) {
                         console.error(`dayChores for ${member.name}, day ${dayIndex} is not an array.`, dayChores);
                         // Fill with empty items if sub-array is malformed
                         for(let k=0; k < choresPerDay; k++) {
                            const emptyChoreItem = document.createElement('div');
                            emptyChoreItem.className = "chore-item";
                            dayChoresCell.appendChild(emptyChoreItem);
                         }
                    } else {
                        dayChores.forEach((chore, choreIndex) => {
                            const choreItemDiv = document.createElement('div');
                            choreItemDiv.className = "chore-item";

                            const checkbox = document.createElement('input');
                            checkbox.type = "checkbox";
                            checkbox.id = `${member.name.toLowerCase().replace(/\s+/g, '-')}-day${dayIndex}-chore${choreIndex}`;
                            checkbox.checked = chore ? chore.checked : false; // Add null check for chore object
                            checkbox.addEventListener('change', (e) => {
                                updateChoreChecked(memberIndex, dayIndex, choreIndex, e.target.checked);
                            });

                            const label = document.createElement('label');
                            label.htmlFor = checkbox.id;
                            label.className = "member-row-text-color";
                            label.contentEditable = "true";
                            label.textContent = chore ? chore.text : ""; // Add null check for chore object
                            label.addEventListener('blur', (e) => {
                                updateChoreText(memberIndex, dayIndex, choreIndex, e.target.textContent);
                            });
                            label.addEventListener('click', (e) => {
                                if (label.isContentEditable) e.preventDefault();
                            });

                            choreItemDiv.appendChild(checkbox);
                            choreItemDiv.appendChild(label);
                            dayChoresCell.appendChild(choreItemDiv);
                        });
                    }
                    choreGrid.appendChild(dayChoresCell);
                });
            });
        }

        // --- Initialize ---
        initializeFirebase();

    </script>
</body>
</html>
